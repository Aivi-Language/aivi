@no_prelude
module integrationTests.stdlib.aivi.network.httpJsonBody.tests

use aivi
use aivi.testing
use aivi.net.http
use aivi.json

@test "Json body variant construction"
jsonBodyVariant = do Effect {
  reqUrl = { protocol: "https", host: "example.com", port: None, path: "/token", query: [], hash: None }
  req = {
    method: "POST"
    url: reqUrl
    headers: []
    body: Some (Json (toJson { grant_type: "authorization_code", code: "abc123" }))
  }
  assertEq req.method "POST"
  req.body match
    | Some (Json _) => assert True
    | _             => assert False
}

@test "record literal coerces to Body"
recordCoercesToBody = do Effect {
  reqUrl = { protocol: "https", host: "example.com", port: None, path: "/token", query: [], hash: None }
  b : Body = { grant_type: "authorization_code", code: "abc123" }
  req = {
    method: "POST"
    url: reqUrl
    headers: []
    body: Some b
  }
  req.body match
    | Some (Json _) => assert True
    | _             => assert False
}

@test "toJson encodes record to JsonObject"
toJsonRecord = do Effect {
  encoded = toJson { name: "Alice", age: 30 }
  encoded match
    | JsonObject _ => assert True
    | _            => assert False
}

@test "toJson encodes text to JsonString"
toJsonText = do Effect {
  encoded = toJson "hello"
  assertEq encoded (JsonString "hello")
}

@test "toJson encodes int to JsonInt"
toJsonInt = do Effect {
  encoded = toJson 42
  assertEq encoded (JsonInt 42)
}

@test "toJson encodes None to JsonNull"
toJsonNone = do Effect {
  encoded = toJson (None : Option Text)
  assertEq encoded JsonNull
}

@test "jsonToText renders object"
jsonToTextObject = do Effect {
  jv = JsonObject [("x", JsonInt 1)]
  t = jsonToText jv
  assertEq t "\{\"x\":1\}"
}

@test "jsonToText renders array"
jsonToTextArray = do Effect {
  jv = JsonArray [JsonInt 1, JsonInt 2]
  t = jsonToText jv
  assertEq t "[1,2]"
}
