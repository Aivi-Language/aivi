@no_prelude
module integrationTests.stdlib.aivi.secrets.tests

use aivi
use aivi.testing
use aivi.secrets

@test "blob accessors"
blob_accessors = do Effect {
  cipher = [1, 2, 3]
  value = blob "key-1" "aes-gcm" cipher
  assertEq (blobKeyId value) "key-1"
  assertEq (blobAlgorithm value) "aes-gcm"
  assertEq (blobCiphertext value) cipher
  assertEq (validateBlob value) True
}

@test "put and get secret"
put_and_get_secret = do Effect {
  value = blob "key-2" "aes-gcm" [7, 8]
  put "key-2" value
  loaded <- get "key-2"
  loaded match
    | Some found => assertEq (blobAlgorithm found) "aes-gcm"
    | None       => assert False
}

@test "delete secret"
delete_secret = do Effect {
  value = blob "key-3" "aes-gcm" [9]
  put "key-3" value
  delete "key-3"
  loaded <- get "key-3"
  loaded match
    | Some _ => assert False
    | None   => assert True
}
