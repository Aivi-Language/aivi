@no_prelude
module integrationTests.stdlib.aivi.prelude.tests

use aivi
use aivi.testing
use aivi.prelude
use aivi.text

@test
bool_smoke = effect {
  assert (True && True)
  assert (True || False)
  assert (False || True)
  assert (!False)
  assert (!(True && False))
  assert (True != False)
  assert (True == True)
}

@test
bytes_smoke = effect {
  b = toBytes Utf8 "abc"
  res = fromBytes Utf8 b
  res ?
    | Ok s  => assertEq s "abc"
    | Err _ => assert False
}

@test
char_smoke = effect {
  pure isAlpha
  assertEq (1 + 1) 2
}

@test
float_smoke = effect {
  assert (1.0 + 2.0 == 3.0)
  assert (2.0 * 3.0 == 6.0)
  assert (4.0 / 2.0 == 2.0)
  assert (1.0 < 2.0)
  assert (2.0 > 1.0)
  assert (1.0 <= 1.0)
  assert (1.0 >= 1.0)
}

@test
int_smoke = effect {
  assertEq (1 + 2) 3
  assertEq (2 * 3) 6
  assertEq (4 / 2) 2
  assert (1 < 2)
  assert (2 > 1)
  assert (1 <= 1)
  assert (1 >= 1)
  minInt = a b => if a < b then a else b
  maxInt = a b => if a > b then a else b
  assert (minInt 1 2 == 1)
  assert (maxInt 1 2 == 2)
}

len = xs => xs ?
  | []           => 0
  | [_, ...rest] => 1 + len rest

map = f xs => xs ?
  | []           => []
  | [x, ...rest] => [f x, ...(map f rest)]

@test
list_smoke = effect {
  l = [1, 2, 3]
  assertEq (len l) 3
  assertEq (map (x => x + 1) l)[2, 3, 4]
}

@test
option_smoke = effect {
  some = Some 1
  some ?
    | Some n => assertEq n 1
    | None   => assert False

    none = None
    none ?
      | Some _ => assert False
      | None   => assert True
}

@test
patch_smoke = effect {
  user = { name: "A", age: 30 }
  older = user <| { age: _ + 1 }
  assertEq older.age 31
}

@test
result_smoke = effect {
  ok = Ok 1
  ok ?
    | Ok n  => assertEq n 1
    | Err _ => assert False

    err = Err "nope"
    err ?
      | Ok _  => assert False
      | Err e => assertEq e "nope"
}

@test
attempt_smoke = effect {
  ok <- attempt (pure 42)
  ok ?
    | Ok n  => assertEq n 42
    | Err _ => assert False

    bad <- attempt (fail "boom")
    bad ?
      | Ok _  => assert False
      | Err e => assertEq e "boom"
}

@test
text_smoke = effect {
  t = "Hello"
  assertEq (length t) 5
  assertEq (toUpper t) "HELLO"
  assertEq (toLower t) "hello"
  assert (isEmpty "" == True)
  assert (isEmpty t == False)
}

@test
toText_smoke = effect {
  assertEq (toText "abc") "abc"
  assertEq (toText 123) "123"
}

@test
tuple_smoke = effect {
  t = (1, "two")
  res = t ?
    | (a, b) => if a == 1 && b == "two" then True else False
    | _      => False
    assert (res == True)
}

@test
toText_smoke_2 = effect {
  pure toText
  assertEq (toText 0) "0"
}
