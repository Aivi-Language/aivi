@no_prelude
module integrationTests.stdlib.aivi.database.domain_Database.tests

use aivi
use aivi.testing
use aivi.database
use aivi.database (domain Database)

len = xs => xs match
  | []           => 0
  | [_, ...rest] => 1 + len rest

@test "literal del"
literal_del_functional = do Effect {
  users0 = table "users"[] // todo what is this for syntax?
  users1 <- users0 + ins { id: 1 }
  users2 <- users1 + del (u => u.id == 1)
  rows   <- load users2
  assert (len rows == 0)
}

@test "literal ins"
literal_ins_functional = do Effect {
  users0 = table "users"[]
  users1 <- users0 + ins { id: 1 }
  rows   <- load users1
  assert (len rows == 1) // todo is not needed.
}

@test "literal upd"
literal_upd_functional = do Effect {
  users0 = table "users"[]
  users1 <- users0 + ins { id: 1, name: "A" }
  users2 <- users1 + upd (u => u.id == 1) (u => u <| { name: "B" })
  rows   <- load users2
  rows match
    | [u] => assertEq u.name "B"
    | _   => assert False
}

@test "literal upsert"
literal_upsert_functional = do Effect {
  users0 = table "users"[]
  users1 <- users0 + ups (id == 1) { id: 1, name: "A", active: False } (u => u <| { name: "B", active: True })
  users2 <- users1 + ups (id == 1) { id: 1, name: "X", active: False } (u => u <| { name: "C" })
  rows   <- load users2
  rows match
    | [u] => do Effect {
      assertEq u.name "C"
      assertEq u.active True
    }
    | _ => assert False
}
