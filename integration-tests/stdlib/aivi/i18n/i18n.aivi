@no_prelude
module integrationTests.stdlib.aivi.i18n.tests

use aivi
use aivi.testing
use aivi.i18n

@test
bundle_smoke = effect {
  loc =
    (parseLocale "en-US") ?
      | Ok l  => l
      | Err _ => { language: "en", region: Some "US", variants: [], tag: "en-US" }

    bres = bundleFromProperties loc "app.welcome = Hello!\n"
    bres ?
      | Err _ => assert False
      | Ok b  => assert (t b (~k"app.welcome") {} == "Hello!")
}

@test
catalog_smoke = effect {
  en =
    (parseLocale "en") ?
      | Ok l  => l
      | Err _ => { language: "en", region: None, variants: [], tag: "en" }
    enUs =
      (parseLocale "en-US") ?
        | Ok l  => l
        | Err _ => { language: "en", region: Some "US", variants: [], tag: "en-US" }

    bEnRes = bundleFromProperties en "app.welcome = Hello\n"
    bEnUsRes = bundleFromProperties enUs "app.welcome = Howdy\n"

    bEn =
      bEnRes ?
        | Ok b  => b
        | Err _ => { locale: en, entries: Map.empty }
    bEnUs =
      bEnUsRes ?
        | Ok b  => b
        | Err _ => { locale: enUs, entries: Map.empty }

    catalog = catalogFromBundles [bEn, bEnUs]
    assert (tCatalog catalog enUs (~k"app.welcome") {} == "Howdy")
}

@test
key_smoke = effect {
  k1 = ~k"app.welcome"
  assert (keyText k1 == "app.welcome")

  kres = key "app.cartItems"
  kres ?
    | Ok k  => assert (keyText k == "app.cartItems")
    | Err _ => assert False
}

@test
locale_smoke = effect {
  res = parseLocale "en_US"
  res ?
    | Ok l  => assert (l.tag == "en-US")
    | Err _ => assert False
}

message_touch : Message -> Unit
message_touch = _ => Unit

@test
message_smoke = effect {
  pure message_touch
  assertEq (1 + 1) 2
}

@test
bundleForLocale_smoke = effect {
  en =
    (parseLocale "en") ?
      | Ok l  => l
      | Err _ => { language: "en", region: None, variants: [], tag: "en" }
    enUs =
      (parseLocale "en-US") ?
        | Ok l  => l
        | Err _ => { language: "en", region: Some "US", variants: [], tag: "en-US" }

    bEnRes = bundleFromProperties en "k = Hello\n"
    bEnUsRes = bundleFromProperties enUs "k = Howdy\n"

    bEn =
      bEnRes ?
        | Ok b  => b
        | Err _ => { locale: en, entries: Map.empty }
    bEnUs =
      bEnUsRes ?
        | Ok b  => b
        | Err _ => { locale: enUs, entries: Map.empty }

    catalog = catalogFromBundles [bEn, bEnUs]
    got = bundleForLocale catalog enUs
    got ?
      | None   => assert False
      | Some b => assert (b.locale.tag == "en-US")
}

@test
bundleFromProperties_smoke = effect {
  l_res = parseLocale "en"
  l <- l_res ?
    | Ok l  => pure l
    | Err e => fail e
    props = "greet = Hello!\nval = 123"
    b_res = bundleFromProperties l props
    b <- b_res ?
      | Ok b  => pure b
      | Err e => fail e
    assert (b.locale.language == "en")
}

@test
bundleFromPropertiesFile_smoke = effect {
  l_res = parseLocale "en"
  l <- l_res ?
    | Ok l  => pure l
    | Err e => fail e

    res <- attempt (bundleFromPropertiesFile l "this-file-should-not-exist.aivi.i18n.properties")
    res ?
      | Ok (Ok _b)  => assert False
      | Ok (Err _e) => assert True
      | Err _e      => assert True
}

@test
bundlesForLocale_smoke = effect {
  en =
    (parseLocale "en") ?
      | Ok l  => l
      | Err _ => { language: "en", region: None, variants: [], tag: "en" }
    enUs =
      (parseLocale "en-US") ?
        | Ok l  => l
        | Err _ => { language: "en", region: Some "US", variants: [], tag: "en-US" }

    bEn =
      (bundleFromProperties en "k = Hello\n") ?
        | Ok b  => b
        | Err _ => { locale: en, entries: Map.empty }
    bEnUs =
      (bundleFromProperties enUs "k = Howdy\n") ?
        | Ok b  => b
        | Err _ => { locale: enUs, entries: Map.empty }

    catalog = catalogFromBundles [bEn, bEnUs]
    bs = bundlesForLocale catalog enUs
    assertEq (List.length bs) 2
}

@test
catalogFromBundles_smoke = effect {
  en =
    (parseLocale "en") ?
      | Ok l  => l
      | Err _ => { language: "en", region: None, variants: [], tag: "en" }
    b =
      (bundleFromProperties en "k = Hello\n") ?
        | Ok b  => b
        | Err _ => { locale: en, entries: Map.empty }
    catalog = catalogFromBundles [b]
    assert (Map.get "en" catalog != None)
}

@test
fallbackTags_smoke = effect {
  loc =
    (parseLocale "zh-Hant-TW") ?
      | Ok l  => l
      | Err _ => { language: "zh", region: Some "TW", variants: ["Hant"], tag: "zh-Hant-TW" }
      assertEq (fallbackTags loc)["zh-Hant-TW", "zh-Hant", "zh"]
}

  @test
  key_smoke_2 = effect {
    mResult = key "hello.world"
    k <- mResult ?
      | Ok k  => effect { pure k }
      | Err e => effect { fail e }
    assert (k.body == "hello.world")
  }

@test
keyText_smoke = effect {
  k <- (key "app.welcome") ?
    | Ok k  => pure k
    | Err e => fail e
    assertEq (keyText k) "app.welcome"
}

@test
message_smoke_2 = effect {
  res = message "Hello!"
  m <- res ?
    | Ok m  => pure m
    | Err e => fail e
    assert (m.body == "Hello!")
}

@test
messageText_smoke = effect {
  m <- (message "Hello!") ?
    | Ok m  => pure m
    | Err e => fail e
    assertEq (messageText m) "Hello!"
}

@test
parseLocale_smoke = effect {
  res = parseLocale "en-US"
  r <- res ?
    | Ok x  => effect { pure x }
    | Err _ => effect { fail "parse failed" }
    assert (r.language == "en")
    assert (r.region == Some "US")
}

@test
render_smoke = effect {
  m_res = message "Hello!"
  m <- m_res ?
    | Ok m  => pure m
    | Err e => fail e

    r_res = render m {}
    r <- r_res ?
      | Ok r  => pure r
      | Err e => fail e

    assert (r == "Hello!")
}

@test
t_smoke = effect {
  en =
    (parseLocale "en") ?
      | Ok l  => l
      | Err _ => { language: "en", region: None, variants: [], tag: "en" }
      b <- (bundleFromProperties en "k = Hello\n") ?
        | Ok b  => pure b
        | Err e => fail e
      k <- (key "k") ?
        | Ok k  => pure k
        | Err e => fail e
      assertEq (t b k {}) "Hello"
      missing <- (key "missing") ?
        | Ok k  => pure k
        | Err e => fail e
      assertEq (t b missing {}) "missing"
}

  @test
  tCatalog_smoke = effect {
    en =
    (parseLocale "en") ?
      | Ok l  => l
      | Err _ => { language: "en", region: None, variants: [], tag: "en" }
    enUs =
    (parseLocale "en-US") ?
      | Ok l  => l
      | Err _ => { language: "en", region: Some "US", variants: [], tag: "en-US" }
    bEn <- (bundleFromProperties en "k = Hello\n") ?
      | Ok b  => pure b
      | Err e => fail e
    bEnUs <- (bundleFromProperties enUs "k = Howdy\n") ?
      | Ok b  => pure b
      | Err e => fail e
    catalog = catalogFromBundles [bEn, bEnUs]
    k <- (key "k") ?
      | Ok k  => pure k
      | Err e => fail e
    assertEq (tCatalog catalog enUs k {}) "Howdy"
  }

@test
tCatalogWithDefault_smoke = effect {
  en =
    (parseLocale "en") ?
      | Ok l  => l
      | Err _ => { language: "en", region: None, variants: [], tag: "en" }
    fr =
      (parseLocale "fr") ?
        | Ok l  => l
        | Err _ => { language: "fr", region: None, variants: [], tag: "fr" }

    catalog = Map.empty
    defaultBundle <- (bundleFromProperties en "k = Hello\n") ?
      | Ok b  => pure b
      | Err e => fail e
    k <- (key "k") ?
      | Ok k  => pure k
      | Err e => fail e
    assertEq (tCatalogWithDefault catalog fr defaultBundle k {}) "Hello"
}

@test
tOpt_smoke = effect {
  en =
    (parseLocale "en") ?
      | Ok l  => l
      | Err _ => { language: "en", region: None, variants: [], tag: "en" }
      b <- (bundleFromProperties en "k = Hello\n") ?
        | Ok b  => pure b
        | Err e => fail e
      k <- (key "k") ?
        | Ok k  => pure k
        | Err e => fail e
      assertEq (tOpt b k {}) (Some "Hello")
}

  @test
  tResult_smoke = effect {
    en =
    (parseLocale "en") ?
      | Ok l  => l
      | Err _ => { language: "en", region: None, variants: [], tag: "en" }
    b <- (bundleFromProperties en "k = Hello\n") ?
      | Ok b  => pure b
      | Err e => fail e
    k <- (key "k") ?
      | Ok k  => pure k
      | Err e => fail e
    assertEq (tResult b k {}) (Ok "Hello")
  }

  @test
  tWithFallback_smoke = effect {
    en =
    (parseLocale "en") ?
      | Ok l  => l
      | Err _ => { language: "en", region: None, variants: [], tag: "en" }
    enUs =
    (parseLocale "en-US") ?
      | Ok l  => l
      | Err _ => { language: "en", region: Some "US", variants: [], tag: "en-US" }
    bEn <- (bundleFromProperties en "k = Hello\n") ?
      | Ok b  => pure b
      | Err e => fail e
    bEnUs <- (bundleFromProperties enUs "k = Howdy\n") ?
      | Ok b  => pure b
      | Err e => fail e
    k <- (key "k") ?
      | Ok k  => pure k
      | Err e => fail e
    assertEq (tWithFallback [bEnUs, bEn] k {}) "Howdy"
  }
