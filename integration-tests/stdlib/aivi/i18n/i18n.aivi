@no_prelude
module integrationTests.stdlib.aivi.i18n.tests

use aivi
use aivi.testing
use aivi.i18n

@test
bundle_smoke = effect {
  loc =
    (parseLocale "en-US") ?
      | Ok l  => l
      | Err _ => { language: "en", region: Some "US", variants: [], tag: "en-US" }

    bres = bundleFromProperties loc "app.welcome = Hello!\n"
    bres ?
      | Err _ => assert False
      | Ok b  => assert (t b (~k"app.welcome") {} == "Hello!")
}

@test
catalog_smoke = effect {
  en =
    (parseLocale "en") ?
      | Ok l  => l
      | Err _ => { language: "en", region: None, variants: [], tag: "en" }
    enUs =
      (parseLocale "en-US") ?
        | Ok l  => l
        | Err _ => { language: "en", region: Some "US", variants: [], tag: "en-US" }

    bEnRes = bundleFromProperties en "app.welcome = Hello\n"
    bEnUsRes = bundleFromProperties enUs "app.welcome = Howdy\n"

    bEn =
      bEnRes ?
        | Ok b  => b
        | Err _ => { locale: en, entries: Map.empty }
    bEnUs =
      bEnUsRes ?
        | Ok b  => b
        | Err _ => { locale: enUs, entries: Map.empty }

    catalog = catalogFromBundles [bEn, bEnUs]
    assert (tCatalog catalog enUs (~k"app.welcome") {} == "Howdy")
}

@test
key_smoke = effect {
  k1 = ~k"app.welcome"
  assert (keyText k1 == "app.welcome")

  kres = key "app.cartItems"
  kres ?
    | Ok k  => assert (keyText k == "app.cartItems")
    | Err _ => assert False
}

@test
locale_smoke = effect {
  res = parseLocale "en_US"
  res ?
    | Ok l  => assert (l.tag == "en-US")
    | Err _ => assert False
}

message_touch : Message -> Unit
message_touch = _ => Unit

@test
message_smoke = effect {
  pure message_touch
  assertEq (1 + 1) 2
}

@test
bundleForLocale_smoke = effect {
  pure bundleForLocale
  assert True
}

@test
bundleFromProperties_smoke = effect {
  l_res = parseLocale "en"
  l <- l_res ?
    | Ok l  => pure l
    | Err e => fail e
    props = "greet = Hello!\nval = 123"
    b_res = bundleFromProperties l props
    b <- b_res ?
      | Ok b  => pure b
      | Err e => fail e
    assert (b.locale.language == "en")
}

@test
bundleFromPropertiesFile_smoke = effect {
  pure bundleFromPropertiesFile
  assert True
}

@test
bundlesForLocale_smoke = effect {
  pure bundlesForLocale
  assert True
}

@test
catalogFromBundles_smoke = effect {
  pure catalogFromBundles
  assert True
}

@test
fallbackTags_smoke = effect {
  pure fallbackTags
  assert True
}

@test
key_smoke_2 = effect {
  mResult = key "hello.world"
  k <- mResult ?
    | Ok k  => effect { pure k }
    | Err e => effect { fail e }
    assert (k.body == "greeting")
}

@test
keyText_smoke = effect {
  pure keyText
  assert True
}

@test
message_smoke_2 = effect {
  res = message "Hello!"
  m <- res ?
    | Ok m  => pure m
    | Err e => fail e
    assert (m.body == "Hello!")
}

@test
messageText_smoke = effect {
  pure messageText
  assert True
}

@test
parseLocale_smoke = effect {
  res = parseLocale "en-US"
  r <- res ?
    | Ok x  => effect { pure x }
    | Err _ => effect { fail "parse failed" }
    assert (r.language == "en")
    assert (r.region == Some "US")
}

@test
render_smoke = effect {
  m_res = message "Hello!"
  m <- m_res ?
    | Ok m  => pure m
    | Err e => fail e

    r_res = render m {}
    r <- r_res ?
      | Ok r  => pure r
      | Err e => fail e

    assert (r == "Hello!")
}

@test
t_smoke = effect {
  pure t
  assert True
}

@test
tCatalog_smoke = effect {
  pure tCatalog
  assert True
}

@test
tCatalogWithDefault_smoke = effect {
  pure tCatalogWithDefault
  assert True
}

@test
tOpt_smoke = effect {
  pure tOpt
  assert True
}

@test
tResult_smoke = effect {
  pure tResult
  assert True
}

@test
tWithFallback_smoke = effect {
  pure tWithFallback
  assert True
}
