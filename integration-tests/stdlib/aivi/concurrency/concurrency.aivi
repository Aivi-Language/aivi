@no_prelude
module integrationTests.stdlib.aivi.concurrency.tests

use aivi
use aivi.testing
use aivi.concurrency

@test "channel error"
channelError_functional = do Effect {
  (tx, rx) <- make Unit
  close tx
  res <- recv rx
  res match
    | Ok _    => assert False
    | Err err => assertEq err Closed
}

@test "scope"
scope_functional = do Effect {
  value <- scope (_ => pure 41)
  assertEq value 41
}

@test "close"
close_functional = do Effect {
  (tx, rx) <- make Unit
  send tx Unit
  first <- recv rx
  close tx
  second <- recv rx
  first match
    | Ok payload => assertEq payload Unit
    | Err _      => assert False
    second match
      | Ok _    => assert False
      | Err err => assertEq err Closed
}

@test "make"
make_functional = do Effect {
  (tx, rx) <- make Unit
  send tx Unit
  res <- recv rx
  res match
    | Ok payload => assertEq payload Unit
    | Err _      => assert False
    close tx
}

@test "par"
par_functional = do Effect {
  pair <- par (pure 1) (pure 2)
  pair match
    | (left, right) => assertEq (left + right) 3
}

@test "makeBounded"
make_bounded_functional = do Effect {
  (tx, rx) <- makeBounded 1
  send tx 7
  first <- recv rx
  first match
    | Ok value => assertEq value 7
    | Err _    => assert False
  close tx
}

@test "timeoutWith"
timeout_with_functional = do Effect {
  result <- attempt (timeoutWith 10 "timeout" (do Effect {
    sleep 50
    pure 1
  }))
  result match
    | Ok _      => assert False
    | Err value => assertEq value "timeout"
}

@test "retry helper"
retry_helper = do Effect {
  value <- retry 3 (pure 11)
  assertEq value 11
}

@test "recv"
  recv_functional = do Effect {
    (tx, rx) <- make Unit
    send tx Unit
    res <- recv rx
    res match
      | Ok payload => assertEq payload Unit
      | Err _      => assert False
    close tx
  }

@test "scope 2"
  scope_functional_2 = do Effect {
  // Scope should run the callback and return its result.
    x <- scope (_ => pure 123)
    assert (x == 123)
  }

@test "send"
  send_functional = do Effect {
    (tx, rx) <- make Unit
    send tx Unit
    res <- recv rx
    res match
      | Ok payload => assertEq payload Unit
      | Err _      => assert False
    close tx
  }
