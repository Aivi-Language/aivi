@no_prelude
module integrationTests.stdlib.aivi.concurrency.tests

use aivi
use aivi.testing
use aivi.concurrency

@test "channel error"
channelError_functional = do Effect {
  assertEq (1 + 1) 2
}

@test "scope"
scope_functional = do Effect {
  assertEq (1 + 1) 2
}

@test "close"
close_functional = do Effect {
  (tx, rx) <- make Unit
  send tx Unit
  res <- recv rx
  res match
    | Ok _  => assert True
    | Err _ => assert False
    close tx
}

@test "make"
make_functional = do Effect {
  (tx, rx) <- make Unit
  send tx Unit
  res <- recv rx
  res match
    | Ok _  => assert True
    | Err _ => assert False
    close tx
}

@test "par"
par_functional = do Effect {
  // Just ensure both branches run without throwing.
  _ <- par (pure 1) (pure 2)
  assert True
}

@test "recv"
recv_functional = do Effect {
  (tx, rx) <- make Unit
  send tx Unit
  res <- recv rx
  res match
    | Ok _  => assert True
    | Err _ => assert False
    close tx
}

@test "scope 2"
scope_functional_2 = do Effect {
  // Scope should run the callback and return its result.
  x <- scope (_ => pure 123)
  assert (x == 123)
}

@test "send"
send_functional = do Effect {
  (tx, rx) <- make Unit
  send tx Unit
  res <- recv rx
  res match
    | Ok _  => assert True
    | Err _ => assert False
    close tx
}
