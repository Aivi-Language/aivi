@no_prelude
module integrationTests.stdlib.aivi.math.tests

use aivi
use aivi.testing
use aivi.math

// -- Constants --

@test "constants pi"
constants_pi = do Effect {
  assert (abs (pi - 3.14159265358979) < 0.00001)
}

@test "constants e"
constants_e = do Effect {
  assert (abs (e - 2.71828182845904) < 0.00001)
}

@test "constants inf"
constants_inf = do Effect {
  assert (isInf inf)
  assert (isInf negInf)
  assert (isFinite 1.0)
  assert (isFinite 0.0)
}

// -- Basic Helpers --

@test "abs int"
abs_int = do Effect {
  assertEq (abs 5) 5
  assertEq (abs (-3)) 3
  assertEq (abs 0) 0
}

@test "abs float"
abs_float = do Effect {
  assert (abs 1.5 == 1.5)
  assert (abs (-2.5) == 2.5)
  assert (abs 0.0 == 0.0)
}

@test "sign"
sign_functional = do Effect {
  assert (sign 5.0 == 1.0)
  assert (sign (-3.0) == -1.0)
  assert (sign 0.0 == 0.0)
}

@test "min max"
min_max = do Effect {
  assert (min 3.0 5.0 == 3.0)
  assert (max 3.0 5.0 == 5.0)
  assert (min (-1.0) 0.0 == -1.0)
}

@test "clamp"
clamp_functional = do Effect {
  assert (clamp 0.0 10.0 5.0 == 5.0)
  assert (clamp 0.0 10.0 (-1.0) == 0.0)
  assert (clamp 0.0 10.0 15.0 == 10.0)
}

@test "sum"
sum_functional = do Effect {
  assert (sum [1.0, 2.0, 3.0] == 6.0)
  assert (sum [] == 0.0)
}

@test "sum int"
sumInt_functional = do Effect {
  assertEq (sumInt [1, 2, 3, 4]) 10
  assertEq (sumInt []) 0
}

// -- Rounding --

@test "floor"
floor_functional = do Effect {
  assert (floor 2.7 == 2.0)
  assert (floor (-2.3) == -3.0)
}

@test "ceil"
ceil_functional = do Effect {
  assert (ceil 2.3 == 3.0)
  assert (ceil (-2.7) == -2.0)
}

@test "round"
round_functional = do Effect {
  assert (round 2.5 == 2.0) // banker's rounding: ties to even
  assert (round 3.5 == 4.0)
  assert (round 2.3 == 2.0)
}

@test "trunc"
trunc_functional = do Effect {
  assert (trunc 2.9 == 2.0)
  assert (trunc (-2.9) == -2.0)
}

// -- Powers and Roots --

@test "pow"
pow_functional = do Effect {
  assert (abs (pow 2.0 3.0-8.0) < 0.0001)
  assert (abs (pow 3.0 2.0-9.0) < 0.0001)
}

@test "sqrt"
sqrt_functional = do Effect {
  assert (abs (sqrt 4.0-2.0) < 0.0001)
  assert (abs (sqrt 9.0-3.0) < 0.0001)
}

@test "cbrt"
cbrt_functional = do Effect {
  assert (abs (cbrt 27.0-3.0) < 0.0001)
  assert (abs (cbrt 8.0-2.0) < 0.0001)
}

@test "hypot"
hypot_functional = do Effect {
  assert (abs (hypot 3.0 4.0-5.0) < 0.0001)
}

// -- Logarithms --

@test "log"
log_functional = do Effect {
  assert (abs (log (exp 1.0) - 1.0) < 0.0001)
  assert (abs (log2 8.0-3.0) < 0.0001)
  assert (abs (log10 100.0-2.0) < 0.0001)
}

@test "exp"
exp_functional = do Effect {
  assert (abs (exp 0.0-1.0) < 0.0001)
  assert (abs (exp 1.0- e) < 0.0001)
}

// -- Trigonometry --

@test "sin cos"
sin_cos_functional = do Effect {
  angle = radians 0.0
  assert (abs (sin angle) < 0.0001)
  assert (abs (cos angle - 1.0) < 0.0001)
}

@test "tan"
tan_functional = do Effect {
  angle = radians 0.0
  assert (abs (tan angle) < 0.0001)
}

// -- Integer Math --

@test "gcd"
gcd_functional = do Effect {
  assertEq (gcd 12 8) 4
  assertEq (gcd 7 5) 1
  assertEq (gcd 0 5) 5
}

@test "lcm"
lcm_functional = do Effect {
  assertEq (lcm 4 6) 12
  assertEq (lcm 3 5) 15
}

@test "divmod"
divmod_functional = do Effect {
  (q, r) = divmod 7 3
  assertEq q 2
  assertEq r 1
}

// -- Floating-point checks --

@test "is na n"
isNaN_functional = do Effect {
  assert (isNaN (0.0 / 0.0))
  assert (isFinite 42.0)
  assert (isFinite (-1.0))
}

// -- Min/Max All --

@test "min all max all"
minAll_maxAll = do Effect {
  assertEq (minAll [3.0, 1.0, 2.0]) (Some 1.0)
  assertEq (maxAll [3.0, 1.0, 2.0]) (Some 3.0)
  assertEq (minAll []) None
  assertEq (maxAll []) None
}
