module examples.net_sockets_streams
export main, echoServer

use aivi.net.sockets
use aivi.testing


main : Effect SocketError Unit
main = effect {
  echoServer 8080
}

echoServer : Int -> Effect SocketError Unit
echoServer = port => effect {
  server <- listen { host: "127.0.0.1", port: port }
  socket <- accept server
  handle socket
}

handle : Connection -> Effect SocketError Unit
handle = socket => effect {
  msg <- recv socket
  _   <- send socket msg
  handle socket
}

__test_sentinel = 0

@test
smoke = effect {
  _ <- pure main
  _ <- assert True
}
