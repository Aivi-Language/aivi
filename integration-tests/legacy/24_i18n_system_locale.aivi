module examples.i18nSystemLocale
export main

use aivi
use aivi.file
use aivi.i18n
use aivi.system
use aivi.testing

defaultLocale : Locale
defaultLocale = { language: "en", region: Some "US", variants: [], tag: "en-US" }

systemLocale : Effect Text Locale
systemLocale = effect {
  tagOpt <- localeTag
  tag =
    tagOpt ?
      | Some t => t
      | None   => defaultLocale.tag
      pure (parseLocale tag or defaultLocale)
}

loadBundle : Locale -> Effect Text Bundle
loadBundle = locale => effect {
  path = if locale.tag == "de-DE" then "integration-tests/legacy/i18n/app.de-DE.properties" else "integration-tests/legacy/i18n/app.en-US.properties"

  h        <- open path
  propsRes <- readAll h

  props <- propsRes ?
    | Ok p  => pure p
    | Err e => fail e

    bundleFromProperties locale props ?
      | Ok b  => pure b
      | Err e => fail e
}

main : Effect Text Unit
main = effect {
  locale <- systemLocale
  bundle <- loadBundle locale

  print (t bundle (~k"app.welcome") { name: "Alice" })
  print (t bundle (~k"app.lastLogin") { when: ~dt(2026-02-12T15:30:00Z) })
}

__test_sentinel = 0

@test
smoke = effect {
  // parseLocale should accept a basic tag
  _ <- assert ((parseLocale "en-US") ? | Ok _ => True | Err _ => False)
}
