
module examples.system_log_database
export main

use aivi
use aivi.database as db
use aivi.system
use aivi.testing


User = { id: Int, name: Text, active: Bool }

userTable = (db.table "users")[
  { name: "id", colType: db.IntType, constraints: [db.NotNull], default: None }
  { name: "name", colType: db.Varchar 64, constraints: [db.NotNull], default: None }
  {
    name: "active"
    colType: db.BoolType
    constraints: [db.NotNull]
    default: Some (db.DefaultBool False)
  }
]

main : Effect Text Unit
main = effect {
  envValue <- env.get "APP_ENV"

  table1 <- db.applyDelta userTable (db.ins { id: 1, name: "Ada", active: False })
  table2 <- db.applyDelta table1 (db.ins { id: 2, name: "Lin", active: True })
  table3 = table2

  rows <- db.load table3

  print "users updated env={envValue} rows={rows}\n"
}

__test_sentinel = 0

@test
smoke = effect {
  _ <- db.configure { driver: db.Sqlite, url: ":memory:" }
  _ <- db.runMigrations[userTable]
  _ <- userTable + db.ins { id: 1, name: "Ada", active: False }
  rows <- db.load userTable
  _ <- assert (length rows == 1)
  _ <- assert (rows[0].name == "Ada")
}
