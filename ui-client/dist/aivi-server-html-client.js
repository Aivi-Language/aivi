(function(){"use strict";function v(){const i=document.getElementById("aivi-server-html-boot");if(!i)return null;try{return JSON.parse(i.textContent||"{}")}catch{return null}}function E(i){return typeof i!="string"||!i?null:i.startsWith("ws://")||i.startsWith("wss://")?i:i.startsWith("/")?(location.protocol==="https:"?"wss://":"ws://")+location.host+i:i}function L(i,r){let d=i;for(;d&&d!==document.body;){if(d.getAttribute&&d.getAttribute(r))return d;d=d.parentNode}return null}function T(){const i=v();if(!i||!i.viewId)return;const r=String(i.viewId),d=E(i.wsUrl??i.wsPath??"/ws");if(!d)return;const b=new WebSocket(d);function o(t){try{b.send(JSON.stringify(t))}catch{}}b.addEventListener("open",()=>{o({t:"hello",viewId:r,url:String(location.href),online:!!navigator.onLine})});const m=new Map;function h(t){const e=m.get(t);if(e)return e;const n=document.querySelector(`[data-aivi-node="${CSS.escape(t)}"]`);return n&&m.set(t,n),n}function x(t,e){const n=h(t);if(!n)return;const a=document.createElement("template");a.innerHTML=String(e||"");const s=a.content.firstElementChild;s&&(n.replaceWith(s),m.clear())}function R(t){if(!(!t||typeof t.op!="string")){if(t.op==="replace")return x(String(t.id||""),t.html);if(t.op==="setText"){const e=h(String(t.id||""));if(!e)return;e.textContent=String(t.text||"");return}if(t.op==="setAttr"){const e=h(String(t.id||""));if(!e)return;e.setAttribute(String(t.name||""),String(t.value||""));return}if(t.op==="removeAttr"){const e=h(String(t.id||""));if(!e)return;e.removeAttribute(String(t.name||""))}}}const g=new Map;function I(t){const e=t&&t.sid;if(typeof e!="number")return;const n=t&&t.p||{},a=t&&t.targets||[];let s=g.get(e);if(!s){let l=function(){if(S=!1,!p.length)return;const k=p;p=[],o({t:"platform",viewId:r,kind:"intersection",p:{sid:e,entries:k}})};const c=new WeakMap,f=new Map;let p=[],S=!1;s={observer:new IntersectionObserver(k=>{for(const y of k){const w=c.get(y.target);typeof w=="number"&&p.push({tid:w,isIntersecting:!!y.isIntersecting,ratio:typeof y.intersectionRatio=="number"?y.intersectionRatio:0})}S||(S=!0,Promise.resolve().then(l))},{root:null,rootMargin:typeof n.rootMargin=="string"?n.rootMargin:"0px",threshold:Array.isArray(n.threshold)?n.threshold:[0]}),elementToTid:c,tidToNodeId:f},g.set(e,s)}for(const l of a){if(!l)continue;const c=l.tid,f=l.nodeId;if(typeof c!="number"||typeof f!="string")continue;const p=h(f);s.tidToNodeId.set(c,f),p&&(s.elementToTid.set(p,c),s.observer.observe(p))}}function A(t){const e=t&&t.sid;if(typeof e!="number")return;const n=g.get(e);if(n){try{n.observer.disconnect()}catch{}g.delete(e)}}function K(t){if(!t||typeof t.kind!="string"||typeof t.rid!="number")return;const e=t.rid;if(t.kind==="clipboard.readText"){if(!navigator.clipboard||!navigator.clipboard.readText)return o({t:"effectResult",viewId:r,rid:e,kind:t.kind,ok:!1,error:"Unavailable"});navigator.clipboard.readText().then(n=>{o({t:"effectResult",viewId:r,rid:e,kind:t.kind,ok:!0,p:{text:String(n)}})}).catch(n=>{o({t:"effectResult",viewId:r,rid:e,kind:t.kind,ok:!1,error:String(n&&n.name||"Error")})});return}if(t.kind==="clipboard.writeText"){if(!navigator.clipboard||!navigator.clipboard.writeText)return o({t:"effectResult",viewId:r,rid:e,kind:t.kind,ok:!1,error:"Unavailable"});const n=t.p&&typeof t.p.text=="string"?t.p.text:"";navigator.clipboard.writeText(n).then(()=>{o({t:"effectResult",viewId:r,rid:e,kind:t.kind,ok:!0,p:{}})}).catch(a=>{o({t:"effectResult",viewId:r,rid:e,kind:t.kind,ok:!1,error:String(a&&a.name||"Error")})})}}b.addEventListener("message",t=>{let e=null;try{e=JSON.parse(String(t.data))}catch{return}if(!(!e||e.viewId!==r)){if(e.t==="patch"&&Array.isArray(e.ops)){for(const n of e.ops)R(n);return}if(e.t==="subscribe"&&e.kind==="intersection")return I(e);if(e.t==="unsubscribe"&&e.kind==="intersection")return A(e);if(e.t==="effect")return K(e)}});function u(t,e){const n=`data-aivi-hid-${t}`;let a=e&&e.target;a&&a.nodeType===3&&(a=a.parentNode);const s=L(a,n);if(!s)return;const l=parseInt(String(s.getAttribute(n)),10);if(!isFinite(l))return;let c={};if(t==="click")c={button:e.button|0,alt:!!e.altKey,ctrl:!!e.ctrlKey,shift:!!e.shiftKey,meta:!!e.metaKey};else if(t==="input"){let f="";try{e.target&&"value"in e.target&&(f=String(e.target.value))}catch{}c={value:f}}else t==="keydown"||t==="keyup"?c={key:String(e.key||""),code:String(e.code||""),alt:!!e.altKey,ctrl:!!e.ctrlKey,shift:!!e.shiftKey,meta:!!e.metaKey,repeat:!!e.repeat,isComposing:!!e.isComposing}:(t==="pointerdown"||t==="pointerup"||t==="pointermove")&&(c={pointerId:e.pointerId|0,pointerType:String(e.pointerType||""),button:e.button|0,buttons:e.buttons|0,clientX:+e.clientX||0,clientY:+e.clientY||0,alt:!!e.altKey,ctrl:!!e.ctrlKey,shift:!!e.shiftKey,meta:!!e.metaKey});o({t:"event",viewId:r,hid:l,kind:t,p:c})}document.addEventListener("click",t=>u("click",t)),document.addEventListener("input",t=>u("input",t)),document.addEventListener("keydown",t=>u("keydown",t)),document.addEventListener("keyup",t=>u("keyup",t)),document.addEventListener("pointerdown",t=>u("pointerdown",t)),document.addEventListener("pointerup",t=>u("pointerup",t)),document.addEventListener("pointermove",t=>u("pointermove",t)),document.addEventListener("focus",t=>{u("focus",t)},!0),document.addEventListener("blur",t=>{u("blur",t)},!0),window.addEventListener("popstate",()=>{o({t:"platform",viewId:r,kind:"popstate",p:{url:String(location.href),path:String(location.pathname),query:String(location.search),hash:String(location.hash)}})}),window.addEventListener("hashchange",t=>{o({t:"platform",viewId:r,kind:"hashchange",p:{url:String(location.href),oldURL:String(t&&t.oldURL?t.oldURL:""),newURL:String(t&&t.newURL?t.newURL:""),hash:String(location.hash)}})}),document.addEventListener("visibilitychange",()=>{o({t:"platform",viewId:r,kind:"visibilitychange",p:{visibilityState:String(document.visibilityState||"")}})}),window.addEventListener("focus",()=>{o({t:"platform",viewId:r,kind:"focus",p:{focused:!0}})}),window.addEventListener("blur",()=>{o({t:"platform",viewId:r,kind:"blur",p:{focused:!1}})}),window.addEventListener("online",()=>{o({t:"platform",viewId:r,kind:"online",p:{online:!0}})}),window.addEventListener("offline",()=>{o({t:"platform",viewId:r,kind:"online",p:{online:!1}})})}T()})();
//# sourceMappingURL=aivi-server-html-client.js.map
