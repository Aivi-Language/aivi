{"version":3,"file":"aivi-server-html-client.js","sources":["../src/patch.ts","../src/intersection.ts","../src/clipboard.ts","../src/ws.ts","../src/events.ts","../src/main.ts"],"sourcesContent":["// ---------------------------------------------------------------------------\n// patch.ts — DOM patch application\n// ---------------------------------------------------------------------------\n\n/** Cache of nodeId → Element for fast lookups. */\nconst nodeCache = new Map<string, Element>();\n\n/** Look up an element by its `data-aivi-node` attribute. */\nfunction getNode(nodeId: string): Element | null {\n  const cached = nodeCache.get(nodeId);\n  if (cached && cached.isConnected) return cached;\n  const el = document.querySelector(`[data-aivi-node=\"${CSS.escape(nodeId)}\"]`);\n  if (el) nodeCache.set(nodeId, el);\n  return el;\n}\n\n/** Replace an element's entire outer HTML. Clears the node cache. */\nfunction replaceOuterHtml(nodeId: string, html: unknown): void {\n  const node = getNode(nodeId);\n  if (!node) return;\n  const tpl = document.createElement(\"template\");\n  tpl.innerHTML = String(html || \"\");\n  const newEl = tpl.content.firstElementChild;\n  if (!newEl) return;\n  node.replaceWith(newEl);\n  nodeCache.clear();\n}\n\n/** Apply a single patch operation. */\nfunction applyOp(op: any): void {\n  if (!op || typeof op.op !== \"string\") return;\n  switch (op.op) {\n    case \"replace\":\n      replaceOuterHtml(String(op.id || \"\"), op.html);\n      break;\n    case \"setText\": {\n      const n = getNode(String(op.id || \"\"));\n      if (n) n.textContent = String(op.text || \"\");\n      break;\n    }\n    case \"setAttr\": {\n      const n = getNode(String(op.id || \"\"));\n      if (n) n.setAttribute(String(op.name || \"\"), String(op.value || \"\"));\n      break;\n    }\n    case \"removeAttr\": {\n      const n = getNode(String(op.id || \"\"));\n      if (n) n.removeAttribute(String(op.name || \"\"));\n      break;\n    }\n  }\n}\n\n/**\n * Apply a batch of patch operations received as a JSON-encoded string.\n * The string may be a JSON array OR a pre-parsed array (if the server\n * wraps ops in the `ops` field of the patch message).\n */\nexport function applyPatches(opsJson: string): void {\n  let ops: unknown[];\n  try {\n    ops = JSON.parse(opsJson);\n  } catch {\n    return;\n  }\n  if (!Array.isArray(ops)) return;\n  for (const op of ops) applyOp(op);\n}\n\nexport { getNode };\n","// ---------------------------------------------------------------------------\n// intersection.ts — IntersectionObserver manager\n// ---------------------------------------------------------------------------\n\nimport type { IntersectionOptionsWire, IntersectionTargetWire, ClientMsg } from \"./types\";\nimport { getNode } from \"./patch\";\n\ninterface IntersectionState {\n  observer: IntersectionObserver;\n  elementToTid: WeakMap<Element, number>;\n  tidToNodeId: Map<number, string>;\n}\n\n/** sid → observer state */\nconst obsMap = new Map<number, IntersectionState>();\n\n/**\n * Subscribe to intersection observations for a set of targets.\n *\n * @param sid         Subscription id\n * @param options     Observer options (rootMargin, threshold)\n * @param targets     List of { tid, nodeId } to observe\n * @param sendPlatform  Callback to send a platform message to the server\n */\nexport function subscribeIntersect(\n  sid: number,\n  options: IntersectionOptionsWire,\n  targets: IntersectionTargetWire[],\n  sendPlatform: (msg: ClientMsg) => void,\n  viewId: string,\n): void {\n  let state = obsMap.get(sid);\n\n  if (!state) {\n    const elementToTid = new WeakMap<Element, number>();\n    const tidToNodeId = new Map<number, string>();\n    let pending: Array<{ tid: number; isIntersecting: boolean; ratio: number }> = [];\n    let scheduled = false;\n\n    function flush(): void {\n      scheduled = false;\n      if (!pending.length) return;\n      const entries = pending;\n      pending = [];\n      sendPlatform({\n        t: \"platform\",\n        viewId,\n        kind: \"intersection\",\n        p: { sid, entries },\n      });\n    }\n\n    const observer = new IntersectionObserver(\n      (entries) => {\n        for (const e of entries) {\n          const tid = elementToTid.get(e.target);\n          if (typeof tid !== \"number\") continue;\n          pending.push({\n            tid,\n            isIntersecting: !!e.isIntersecting,\n            ratio: typeof e.intersectionRatio === \"number\" ? e.intersectionRatio : 0,\n          });\n        }\n        if (!scheduled) {\n          scheduled = true;\n          requestAnimationFrame(flush);\n        }\n      },\n      {\n        root: null,\n        rootMargin: typeof options.rootMargin === \"string\" ? options.rootMargin : \"0px\",\n        threshold: Array.isArray(options.threshold) ? options.threshold : [0],\n      },\n    );\n\n    state = { observer, elementToTid, tidToNodeId };\n    obsMap.set(sid, state);\n  }\n\n  for (const t of targets) {\n    if (!t || typeof t.tid !== \"number\" || typeof t.nodeId !== \"string\") continue;\n    state.tidToNodeId.set(t.tid, t.nodeId);\n    const el = getNode(t.nodeId);\n    if (!el) continue;\n    state.elementToTid.set(el, t.tid);\n    state.observer.observe(el);\n  }\n}\n\n/**\n * Unsubscribe from intersection observations.\n */\nexport function unsubscribeIntersect(sid: number): void {\n  const state = obsMap.get(sid);\n  if (!state) return;\n  try {\n    state.observer.disconnect();\n  } catch {\n    // ignore\n  }\n  obsMap.delete(sid);\n}\n","// ---------------------------------------------------------------------------\n// clipboard.ts — Clipboard effect executor\n// ---------------------------------------------------------------------------\n\nimport type { ClientMsg, ClipboardOpWire } from \"./types\";\n\nfunction errorName(e: unknown): string {\n  if (e && typeof e === \"object\" && \"name\" in e) return String((e as any).name);\n  return \"Error\";\n}\n\n/**\n * Execute a clipboard effect request and send the result back to the server.\n *\n * @param rid   Request id from the server\n * @param op    The clipboard operation descriptor\n * @param send  Callback to send the EffectResult message\n * @param viewId  Current view id\n */\nexport function handleClipboardEffect(\n  rid: number,\n  op: ClipboardOpWire,\n  send: (msg: ClientMsg) => void,\n  viewId: string,\n): void {\n  const kind = op.kind;\n\n  if (kind === \"clipboard.readText\") {\n    if (!navigator.clipboard || !navigator.clipboard.readText) {\n      send({\n        t: \"effectResult\",\n        viewId,\n        rid,\n        kind,\n        ok: false,\n        error: \"Unavailable\",\n      });\n      return;\n    }\n    navigator.clipboard\n      .readText()\n      .then((text) => {\n        send({ t: \"effectResult\", viewId, rid, kind, ok: true, p: { text } });\n      })\n      .catch((e) => {\n        send({\n          t: \"effectResult\",\n          viewId,\n          rid,\n          kind,\n          ok: false,\n          error: errorName(e),\n        });\n      });\n    return;\n  }\n\n  if (kind === \"clipboard.writeText\") {\n    if (!navigator.clipboard || !navigator.clipboard.writeText) {\n      send({\n        t: \"effectResult\",\n        viewId,\n        rid,\n        kind,\n        ok: false,\n        error: \"Unavailable\",\n      });\n      return;\n    }\n    const text = op.text ?? \"\";\n    navigator.clipboard\n      .writeText(text)\n      .then(() => {\n        send({ t: \"effectResult\", viewId, rid, kind, ok: true, p: {} });\n      })\n      .catch((e) => {\n        send({\n          t: \"effectResult\",\n          viewId,\n          rid,\n          kind,\n          ok: false,\n          error: errorName(e),\n        });\n      });\n  }\n}\n","// ---------------------------------------------------------------------------\n// ws.ts — WebSocket lifecycle + reconnect\n// ---------------------------------------------------------------------------\n\nimport type { Boot, ClientMsg, ServerMsg } from \"./types\";\nimport { applyPatches } from \"./patch\";\nimport { subscribeIntersect, unsubscribeIntersect } from \"./intersection\";\nimport { handleClipboardEffect } from \"./clipboard\";\n\n/** Read the boot blob from the DOM. */\nfunction getBoot(): Boot | null {\n  const el = document.getElementById(\"aivi-server-html-boot\");\n  if (!el) return null;\n  try {\n    return JSON.parse(el.textContent || \"{}\") as Boot;\n  } catch {\n    return null;\n  }\n}\n\n/** Resolve a wsUrl (relative or absolute) to a full WebSocket URL. */\nfunction resolveWsUrl(wsUrl: unknown): string | null {\n  if (typeof wsUrl !== \"string\" || !wsUrl) return null;\n  if (wsUrl.startsWith(\"ws://\") || wsUrl.startsWith(\"wss://\")) return wsUrl;\n  if (wsUrl.startsWith(\"/\")) {\n    const proto = location.protocol === \"https:\" ? \"wss://\" : \"ws://\";\n    return proto + location.host + wsUrl;\n  }\n  return wsUrl;\n}\n\n// -- State ------------------------------------------------------------------\n\nlet viewId = \"\";\nlet wsUrl: string | null = null;\nlet socket: WebSocket | null = null;\nlet reconnectDelay = 1000;\nconst MAX_RECONNECT_DELAY = 30000;\nconst queue: ClientMsg[] = [];\n\n// -- Public API -------------------------------------------------------------\n\n/** Send a ClientMsg to the server. Queues if not yet connected. */\nexport function send(msg: ClientMsg): void {\n  if (socket && socket.readyState === WebSocket.OPEN) {\n    try {\n      socket.send(JSON.stringify(msg));\n    } catch {\n      // ignore\n    }\n  } else {\n    queue.push(msg);\n  }\n}\n\n/** Flush any queued messages. */\nfunction flushQueue(): void {\n  while (queue.length > 0) {\n    const msg = queue.shift()!;\n    send(msg);\n  }\n}\n\n// -- Message handler --------------------------------------------------------\n\nfunction handleServerMsg(msg: ServerMsg): void {\n  switch (msg.t) {\n    case \"patch\":\n      applyPatches(msg.ops);\n      break;\n\n    case \"error\":\n      console.warn(\"[aivi] server error:\", msg.code, msg.detail);\n      break;\n\n    case \"subscribeIntersect\":\n      subscribeIntersect(msg.sid, msg.options, msg.targets, send, viewId);\n      break;\n\n    case \"unsubscribeIntersect\":\n      unsubscribeIntersect(msg.sid);\n      break;\n\n    case \"effectReq\":\n      handleClipboardEffect(msg.rid, msg.op, send, viewId);\n      break;\n\n    default: {\n      // Exhaustiveness guard — should never reach here if ServerMsg is correct.\n      const _never: never = msg;\n      console.warn(\"[aivi] unknown server msg type:\", (_never as any).t);\n    }\n  }\n}\n\n// -- Connection lifecycle ---------------------------------------------------\n\nfunction connect(): void {\n  if (!wsUrl) return;\n  socket = new WebSocket(wsUrl);\n\n  socket.addEventListener(\"open\", () => {\n    reconnectDelay = 1000;\n    send({ t: \"hello\", viewId, url: String(location.href), online: !!navigator.onLine });\n    flushQueue();\n  });\n\n  socket.addEventListener(\"message\", (ev) => {\n    let msg: ServerMsg | null = null;\n    try {\n      msg = JSON.parse(String(ev.data)) as ServerMsg;\n    } catch {\n      return;\n    }\n    if (!msg) return;\n    handleServerMsg(msg);\n  });\n\n  socket.addEventListener(\"close\", () => {\n    socket = null;\n    scheduleReconnect();\n  });\n\n  socket.addEventListener(\"error\", () => {\n    // close will fire after error; reconnect happens there.\n  });\n}\n\nfunction scheduleReconnect(): void {\n  const delay = reconnectDelay;\n  reconnectDelay = Math.min(reconnectDelay * 2, MAX_RECONNECT_DELAY);\n  setTimeout(connect, delay);\n}\n\n// -- Init -------------------------------------------------------------------\n\n/** Initialize the WebSocket connection from the boot blob. */\nexport function initWs(): void {\n  const boot = getBoot();\n  if (!boot || !boot.viewId) return;\n  viewId = String(boot.viewId);\n  wsUrl = resolveWsUrl(boot.wsUrl ?? boot.wsPath ?? \"/aivi/live\");\n  if (!wsUrl) return;\n  connect();\n}\n","// ---------------------------------------------------------------------------\n// events.ts — Delegated DOM listeners + payload extractors\n// ---------------------------------------------------------------------------\n\nimport type { ClickPayload, InputPayload, KeyPayload, PointerPayload } from \"./types\";\n\n/** Walk up from target to find nearest element with the given attribute. */\nfunction closestWithAttr(el: unknown, attr: string): Element | null {\n  let cur: any = el;\n  while (cur && cur !== document.body && cur !== document) {\n    if (cur.getAttribute && cur.getAttribute(attr)) return cur as Element;\n    cur = cur.parentNode;\n  }\n  return null;\n}\n\n// -- Payload extractors (field names match AIVI payload records exactly) ----\n\nexport function extractClick(e: MouseEvent): ClickPayload {\n  return {\n    button: e.button | 0,\n    alt: !!e.altKey,\n    ctrl: !!e.ctrlKey,\n    shift: !!e.shiftKey,\n    meta: !!e.metaKey,\n  };\n}\n\nexport function extractInput(e: Event): InputPayload {\n  let value = \"\";\n  try {\n    const t = e.target as any;\n    if (t && \"value\" in t) value = String(t.value);\n  } catch {\n    // ignore\n  }\n  return { value };\n}\n\nexport function extractKey(e: KeyboardEvent): KeyPayload {\n  return {\n    key: String(e.key || \"\"),\n    code: String(e.code || \"\"),\n    alt: !!e.altKey,\n    ctrl: !!e.ctrlKey,\n    shift: !!e.shiftKey,\n    meta: !!e.metaKey,\n    repeat: !!e.repeat,\n    isComposing: !!e.isComposing,\n  };\n}\n\nexport function extractPointer(e: PointerEvent): PointerPayload {\n  return {\n    pointerId: e.pointerId | 0,\n    pointerType: String(e.pointerType || \"\"),\n    button: e.button | 0,\n    buttons: e.buttons | 0,\n    clientX: +e.clientX || 0,\n    clientY: +e.clientY || 0,\n    alt: !!e.altKey,\n    ctrl: !!e.ctrlKey,\n    shift: !!e.shiftKey,\n    meta: !!e.metaKey,\n  };\n}\n\ntype ExtractorMap = Record<string, (e: any) => unknown>;\n\nconst extractors: ExtractorMap = {\n  click: extractClick,\n  input: extractInput,\n  keydown: extractKey,\n  keyup: extractKey,\n  pointerdown: extractPointer,\n  pointerup: extractPointer,\n  pointermove: extractPointer,\n};\n\n/** Supported event kinds. */\nexport const EVENT_KINDS = [\n  \"click\",\n  \"input\",\n  \"keydown\",\n  \"keyup\",\n  \"pointerdown\",\n  \"pointerup\",\n  \"pointermove\",\n] as const;\n\n/**\n * Install ONE delegated listener per event kind on `document`.\n * `sendEvent` is called with `(hid, kind, payload)` when a matching\n * handler id is found.\n */\nexport function installEventListeners(\n  sendEvent: (hid: number, kind: string, payload: unknown) => void,\n): void {\n  function handleDomEvent(kind: string, ev: Event): void {\n    const attr = `data-aivi-hid-${kind}`;\n    let target: any = ev.target;\n    if (target && target.nodeType === 3) target = target.parentNode;\n    const el = closestWithAttr(target, attr);\n    if (!el) return;\n    const hid = parseInt(String(el.getAttribute(attr)), 10);\n    if (!isFinite(hid)) return;\n    const extractor = extractors[kind];\n    const payload = extractor ? extractor(ev) : {};\n    sendEvent(hid, kind, payload);\n  }\n\n  for (const kind of EVENT_KINDS) {\n    // focus/blur need capturing to reach the document listener.\n    document.addEventListener(kind, (ev) => handleDomEvent(kind, ev));\n  }\n  document.addEventListener(\"focus\", (ev) => handleDomEvent(\"focus\", ev), true);\n  document.addEventListener(\"blur\", (ev) => handleDomEvent(\"blur\", ev), true);\n}\n","// ---------------------------------------------------------------------------\n// main.ts — Entry point (IIFE side-effect)\n// ---------------------------------------------------------------------------\n\nimport { initWs, send } from \"./ws\";\nimport { installEventListeners } from \"./events\";\n\n// -- Boot -------------------------------------------------------------------\n\n/** Build a UrlInfo payload from the current window.location. */\nfunction buildUrlInfo(): { href: string; path: string; query: string; hash: string } {\n  return {\n    href: String(location.href),\n    path: String(location.pathname),\n    query: String(location.search),\n    hash: String(location.hash),\n  };\n}\n\n/** Read the viewId from the boot blob (duplicated from ws.ts for platform listeners). */\nfunction getViewId(): string {\n  const el = document.getElementById(\"aivi-server-html-boot\");\n  if (!el) return \"\";\n  try {\n    const boot = JSON.parse(el.textContent || \"{}\");\n    return String(boot.viewId || \"\");\n  } catch {\n    return \"\";\n  }\n}\n\nfunction start(): void {\n  // 1. Initialize WebSocket\n  initWs();\n\n  // 2. Install delegated DOM event listeners\n  const viewId = getViewId();\n  installEventListeners((hid, kind, payload) => {\n    send({ t: \"event\", viewId, hid, kind, p: payload });\n  });\n\n  // 3. Install platform listeners\n\n  window.addEventListener(\"popstate\", () => {\n    send({\n      t: \"platform\",\n      viewId,\n      kind: \"popstate\",\n      p: buildUrlInfo(),\n    });\n  });\n\n  window.addEventListener(\"hashchange\", (ev: HashChangeEvent) => {\n    send({\n      t: \"platform\",\n      viewId,\n      kind: \"hashchange\",\n      p: {\n        url: buildUrlInfo(),\n        oldURL: String(ev.oldURL || \"\"),\n        newURL: String(ev.newURL || \"\"),\n        hash: String(location.hash),\n      },\n    });\n  });\n\n  document.addEventListener(\"visibilitychange\", () => {\n    send({\n      t: \"platform\",\n      viewId,\n      kind: \"visibility\",\n      p: { state: String(document.visibilityState || \"\") },\n    });\n  });\n\n  window.addEventListener(\"focus\", () => {\n    send({\n      t: \"platform\",\n      viewId,\n      kind: \"focus\",\n      p: { focused: true },\n    });\n  });\n\n  window.addEventListener(\"blur\", () => {\n    send({\n      t: \"platform\",\n      viewId,\n      kind: \"focus\",\n      p: { focused: false },\n    });\n  });\n\n  window.addEventListener(\"online\", () => {\n    send({\n      t: \"platform\",\n      viewId,\n      kind: \"online\",\n      p: { online: true },\n    });\n  });\n\n  window.addEventListener(\"offline\", () => {\n    send({\n      t: \"platform\",\n      viewId,\n      kind: \"online\",\n      p: { online: false },\n    });\n  });\n}\n\nstart();\n"],"names":["nodeCache","getNode","nodeId","cached","el","replaceOuterHtml","html","node","tpl","newEl","applyOp","op","n","applyPatches","opsJson","ops","obsMap","subscribeIntersect","sid","options","targets","sendPlatform","viewId","state","flush","scheduled","pending","entries","elementToTid","tidToNodeId","e","tid","t","unsubscribeIntersect","errorName","handleClipboardEffect","rid","send","kind","text","getBoot","resolveWsUrl","wsUrl","socket","reconnectDelay","MAX_RECONNECT_DELAY","queue","msg","flushQueue","handleServerMsg","connect","ev","scheduleReconnect","delay","initWs","boot","closestWithAttr","attr","cur","extractClick","extractInput","value","extractKey","extractPointer","extractors","EVENT_KINDS","installEventListeners","sendEvent","handleDomEvent","target","hid","extractor","payload","buildUrlInfo","getViewId","start"],"mappings":"yBAKA,MAAMA,MAAgB,IAGtB,SAASC,EAAQC,EAAgC,CAC/C,MAAMC,EAASH,EAAU,IAAIE,CAAM,EACnC,GAAIC,GAAUA,EAAO,YAAa,OAAOA,EACzC,MAAMC,EAAK,SAAS,cAAc,oBAAoB,IAAI,OAAOF,CAAM,CAAC,IAAI,EAC5E,OAAIE,GAAIJ,EAAU,IAAIE,EAAQE,CAAE,EACzBA,CACT,CAGA,SAASC,EAAiBH,EAAgBI,EAAqB,CAC7D,MAAMC,EAAON,EAAQC,CAAM,EAC3B,GAAI,CAACK,EAAM,OACX,MAAMC,EAAM,SAAS,cAAc,UAAU,EAC7CA,EAAI,UAAY,OAAOF,GAAQ,EAAE,EACjC,MAAMG,EAAQD,EAAI,QAAQ,kBACrBC,IACLF,EAAK,YAAYE,CAAK,EACtBT,EAAU,MAAA,EACZ,CAGA,SAASU,EAAQC,EAAe,CAC9B,GAAI,GAACA,GAAM,OAAOA,EAAG,IAAO,UAC5B,OAAQA,EAAG,GAAA,CACT,IAAK,UACHN,EAAiB,OAAOM,EAAG,IAAM,EAAE,EAAGA,EAAG,IAAI,EAC7C,MACF,IAAK,UAAW,CACd,MAAMC,EAAIX,EAAQ,OAAOU,EAAG,IAAM,EAAE,CAAC,EACjCC,IAAGA,EAAE,YAAc,OAAOD,EAAG,MAAQ,EAAE,GAC3C,KACF,CACA,IAAK,UAAW,CACd,MAAMC,EAAIX,EAAQ,OAAOU,EAAG,IAAM,EAAE,CAAC,EACjCC,GAAGA,EAAE,aAAa,OAAOD,EAAG,MAAQ,EAAE,EAAG,OAAOA,EAAG,OAAS,EAAE,CAAC,EACnE,KACF,CACA,IAAK,aAAc,CACjB,MAAMC,EAAIX,EAAQ,OAAOU,EAAG,IAAM,EAAE,CAAC,EACjCC,GAAGA,EAAE,gBAAgB,OAAOD,EAAG,MAAQ,EAAE,CAAC,EAC9C,KACF,CAAA,CAEJ,CAOO,SAASE,EAAaC,EAAuB,CAClD,IAAIC,EACJ,GAAI,CACFA,EAAM,KAAK,MAAMD,CAAO,CAC1B,MAAQ,CACN,MACF,CACA,GAAK,MAAM,QAAQC,CAAG,EACtB,UAAWJ,KAAMI,EAAKL,EAAQC,CAAE,CAClC,CCrDA,MAAMK,MAAa,IAUZ,SAASC,EACdC,EACAC,EACAC,EACAC,EACAC,EACM,CACN,IAAIC,EAAQP,EAAO,IAAIE,CAAG,EAE1B,GAAI,CAACK,EAAO,CAMV,IAASC,EAAT,UAAuB,CAErB,GADAC,EAAY,GACR,CAACC,EAAQ,OAAQ,OACrB,MAAMC,EAAUD,EAChBA,EAAU,CAAA,EACVL,EAAa,CACX,EAAG,WACH,OAAAC,EACA,KAAM,eACN,EAAG,CAAE,IAAAJ,EAAK,QAAAS,CAAA,CAAQ,CACnB,CACH,EAhBA,MAAMC,MAAmB,QACnBC,MAAkB,IACxB,IAAIH,EAA0E,CAAA,EAC1ED,EAAY,GAsChBF,EAAQ,CAAE,SAvBO,IAAI,qBAClBI,GAAY,CACX,UAAWG,KAAKH,EAAS,CACvB,MAAMI,EAAMH,EAAa,IAAIE,EAAE,MAAM,EACjC,OAAOC,GAAQ,UACnBL,EAAQ,KAAK,CACX,IAAAK,EACA,eAAgB,CAAC,CAACD,EAAE,eACpB,MAAO,OAAOA,EAAE,mBAAsB,SAAWA,EAAE,kBAAoB,CAAA,CACxE,CACH,CACKL,IACHA,EAAY,GACZ,sBAAsBD,CAAK,EAE/B,EACA,CACE,KAAM,KACN,WAAY,OAAOL,EAAQ,YAAe,SAAWA,EAAQ,WAAa,MAC1E,UAAW,MAAM,QAAQA,EAAQ,SAAS,EAAIA,EAAQ,UAAY,CAAC,CAAC,CAAA,CACtE,EAGkB,aAAAS,EAAc,YAAAC,CAAA,EAClCb,EAAO,IAAIE,EAAKK,CAAK,CACvB,CAEA,UAAWS,KAAKZ,EAAS,CACvB,GAAI,CAACY,GAAK,OAAOA,EAAE,KAAQ,UAAY,OAAOA,EAAE,QAAW,SAAU,SACrET,EAAM,YAAY,IAAIS,EAAE,IAAKA,EAAE,MAAM,EACrC,MAAM5B,EAAKH,EAAQ+B,EAAE,MAAM,EACtB5B,IACLmB,EAAM,aAAa,IAAInB,EAAI4B,EAAE,GAAG,EAChCT,EAAM,SAAS,QAAQnB,CAAE,EAC3B,CACF,CAKO,SAAS6B,EAAqBf,EAAmB,CACtD,MAAMK,EAAQP,EAAO,IAAIE,CAAG,EAC5B,GAAKK,EACL,IAAI,CACFA,EAAM,SAAS,WAAA,CACjB,MAAQ,CAER,CACAP,EAAO,OAAOE,CAAG,EACnB,CC/FA,SAASgB,EAAUJ,EAAoB,CACrC,OAAIA,GAAK,OAAOA,GAAM,UAAY,SAAUA,EAAU,OAAQA,EAAU,IAAI,EACrE,OACT,CAUO,SAASK,EACdC,EACAzB,EACA0B,EACAf,EACM,CACN,MAAMgB,EAAO3B,EAAG,KAEhB,GAAI2B,IAAS,qBAAsB,CACjC,GAAI,CAAC,UAAU,WAAa,CAAC,UAAU,UAAU,SAAU,CACzDD,EAAK,CACH,EAAG,eACH,OAAAf,EACA,IAAAc,EACA,KAAAE,EACA,GAAI,GACJ,MAAO,aAAA,CACR,EACD,MACF,CACA,UAAU,UACP,SAAA,EACA,KAAMC,GAAS,CACdF,EAAK,CAAE,EAAG,eAAgB,OAAAf,EAAQ,IAAAc,EAAK,KAAAE,EAAM,GAAI,GAAM,EAAG,CAAE,KAAAC,CAAA,CAAK,CAAG,CACtE,CAAC,EACA,MAAOT,GAAM,CACZO,EAAK,CACH,EAAG,eACH,OAAAf,EACA,IAAAc,EACA,KAAAE,EACA,GAAI,GACJ,MAAOJ,EAAUJ,CAAC,CAAA,CACnB,CACH,CAAC,EACH,MACF,CAEA,GAAIQ,IAAS,sBAAuB,CAClC,GAAI,CAAC,UAAU,WAAa,CAAC,UAAU,UAAU,UAAW,CAC1DD,EAAK,CACH,EAAG,eACH,OAAAf,EACA,IAAAc,EACA,KAAAE,EACA,GAAI,GACJ,MAAO,aAAA,CACR,EACD,MACF,CACA,MAAMC,EAAO5B,EAAG,MAAQ,GACxB,UAAU,UACP,UAAU4B,CAAI,EACd,KAAK,IAAM,CACVF,EAAK,CAAE,EAAG,eAAgB,OAAAf,EAAQ,IAAAc,EAAK,KAAAE,EAAM,GAAI,GAAM,EAAG,CAAA,CAAC,CAAG,CAChE,CAAC,EACA,MAAOR,GAAM,CACZO,EAAK,CACH,EAAG,eACH,OAAAf,EACA,IAAAc,EACA,KAAAE,EACA,GAAI,GACJ,MAAOJ,EAAUJ,CAAC,CAAA,CACnB,CACH,CAAC,CACL,CACF,CC5EA,SAASU,GAAuB,CAC9B,MAAMpC,EAAK,SAAS,eAAe,uBAAuB,EAC1D,GAAI,CAACA,EAAI,OAAO,KAChB,GAAI,CACF,OAAO,KAAK,MAAMA,EAAG,aAAe,IAAI,CAC1C,MAAQ,CACN,OAAO,IACT,CACF,CAGA,SAASqC,EAAaC,EAA+B,CACnD,OAAI,OAAOA,GAAU,UAAY,CAACA,EAAc,KAC5CA,EAAM,WAAW,OAAO,GAAKA,EAAM,WAAW,QAAQ,EAAUA,EAChEA,EAAM,WAAW,GAAG,GACR,SAAS,WAAa,SAAW,SAAW,SAC3C,SAAS,KAAOA,EAE1BA,CACT,CAIA,IAAIpB,EAAS,GACToB,EAAuB,KACvBC,EAA2B,KAC3BC,EAAiB,IACrB,MAAMC,EAAsB,IACtBC,EAAqB,CAAA,EAKpB,SAAST,EAAKU,EAAsB,CACzC,GAAIJ,GAAUA,EAAO,aAAe,UAAU,KAC5C,GAAI,CACFA,EAAO,KAAK,KAAK,UAAUI,CAAG,CAAC,CACjC,MAAQ,CAER,MAEAD,EAAM,KAAKC,CAAG,CAElB,CAGA,SAASC,GAAmB,CAC1B,KAAOF,EAAM,OAAS,GAAG,CACvB,MAAMC,EAAMD,EAAM,MAAA,EAClBT,EAAKU,CAAG,CACV,CACF,CAIA,SAASE,EAAgBF,EAAsB,CAC7C,OAAQA,EAAI,EAAA,CACV,IAAK,QACHlC,EAAakC,EAAI,GAAG,EACpB,MAEF,IAAK,QACH,QAAQ,KAAK,uBAAwBA,EAAI,KAAMA,EAAI,MAAM,EACzD,MAEF,IAAK,qBACH9B,EAAmB8B,EAAI,IAAKA,EAAI,QAASA,EAAI,QAASV,EAAMf,CAAM,EAClE,MAEF,IAAK,uBACHW,EAAqBc,EAAI,GAAG,EAC5B,MAEF,IAAK,YACHZ,EAAsBY,EAAI,IAAKA,EAAI,GAAIV,EAAMf,CAAM,EACnD,MAEF,QAGE,QAAQ,KAAK,kCADSyB,EAC0C,CAAC,CACnE,CAEJ,CAIA,SAASG,GAAgB,CAClBR,IACLC,EAAS,IAAI,UAAUD,CAAK,EAE5BC,EAAO,iBAAiB,OAAQ,IAAM,CACpCC,EAAiB,IACjBP,EAAK,CAAE,EAAG,QAAS,OAAAf,EAAQ,IAAK,OAAO,SAAS,IAAI,EAAG,OAAQ,CAAC,CAAC,UAAU,OAAQ,EACnF0B,EAAA,CACF,CAAC,EAEDL,EAAO,iBAAiB,UAAYQ,GAAO,CACzC,IAAIJ,EAAwB,KAC5B,GAAI,CACFA,EAAM,KAAK,MAAM,OAAOI,EAAG,IAAI,CAAC,CAClC,MAAQ,CACN,MACF,CACKJ,GACLE,EAAgBF,CAAG,CACrB,CAAC,EAEDJ,EAAO,iBAAiB,QAAS,IAAM,CACrCA,EAAS,KACTS,EAAA,CACF,CAAC,EAEDT,EAAO,iBAAiB,QAAS,IAAM,CAEvC,CAAC,EACH,CAEA,SAASS,GAA0B,CACjC,MAAMC,EAAQT,EACdA,EAAiB,KAAK,IAAIA,EAAiB,EAAGC,CAAmB,EACjE,WAAWK,EAASG,CAAK,CAC3B,CAKO,SAASC,GAAe,CAC7B,MAAMC,EAAOf,EAAA,EACT,CAACe,GAAQ,CAACA,EAAK,SACnBjC,EAAS,OAAOiC,EAAK,MAAM,EAC3Bb,EAAQD,EAAac,EAAK,OAASA,EAAK,QAAU,YAAY,EACzDb,GACLQ,EAAA,EACF,CCzIA,SAASM,EAAgBpD,EAAaqD,EAA8B,CAClE,IAAIC,EAAWtD,EACf,KAAOsD,GAAOA,IAAQ,SAAS,MAAQA,IAAQ,UAAU,CACvD,GAAIA,EAAI,cAAgBA,EAAI,aAAaD,CAAI,EAAG,OAAOC,EACvDA,EAAMA,EAAI,UACZ,CACA,OAAO,IACT,CAIO,SAASC,EAAa7B,EAA6B,CACxD,MAAO,CACL,OAAQA,EAAE,OAAS,EACnB,IAAK,CAAC,CAACA,EAAE,OACT,KAAM,CAAC,CAACA,EAAE,QACV,MAAO,CAAC,CAACA,EAAE,SACX,KAAM,CAAC,CAACA,EAAE,OAAA,CAEd,CAEO,SAAS8B,EAAa9B,EAAwB,CACnD,IAAI+B,EAAQ,GACZ,GAAI,CACF,MAAM7B,EAAIF,EAAE,OACRE,GAAK,UAAWA,IAAG6B,EAAQ,OAAO7B,EAAE,KAAK,EAC/C,MAAQ,CAER,CACA,MAAO,CAAE,MAAA6B,CAAA,CACX,CAEO,SAASC,EAAWhC,EAA8B,CACvD,MAAO,CACL,IAAK,OAAOA,EAAE,KAAO,EAAE,EACvB,KAAM,OAAOA,EAAE,MAAQ,EAAE,EACzB,IAAK,CAAC,CAACA,EAAE,OACT,KAAM,CAAC,CAACA,EAAE,QACV,MAAO,CAAC,CAACA,EAAE,SACX,KAAM,CAAC,CAACA,EAAE,QACV,OAAQ,CAAC,CAACA,EAAE,OACZ,YAAa,CAAC,CAACA,EAAE,WAAA,CAErB,CAEO,SAASiC,EAAejC,EAAiC,CAC9D,MAAO,CACL,UAAWA,EAAE,UAAY,EACzB,YAAa,OAAOA,EAAE,aAAe,EAAE,EACvC,OAAQA,EAAE,OAAS,EACnB,QAASA,EAAE,QAAU,EACrB,QAAS,CAACA,EAAE,SAAW,EACvB,QAAS,CAACA,EAAE,SAAW,EACvB,IAAK,CAAC,CAACA,EAAE,OACT,KAAM,CAAC,CAACA,EAAE,QACV,MAAO,CAAC,CAACA,EAAE,SACX,KAAM,CAAC,CAACA,EAAE,OAAA,CAEd,CAIA,MAAMkC,EAA2B,CAC/B,MAAOL,EACP,MAAOC,EACP,QAASE,EACT,MAAOA,EACP,YAAaC,EACb,UAAWA,EACX,YAAaA,CACf,EAGaE,EAAc,CACzB,QACA,QACA,UACA,QACA,cACA,YACA,aACF,EAOO,SAASC,EACdC,EACM,CACN,SAASC,EAAe9B,EAAca,EAAiB,CACrD,MAAMM,EAAO,iBAAiBnB,CAAI,GAClC,IAAI+B,EAAclB,EAAG,OACjBkB,GAAUA,EAAO,WAAa,MAAYA,EAAO,YACrD,MAAMjE,EAAKoD,EAAgBa,EAAQZ,CAAI,EACvC,GAAI,CAACrD,EAAI,OACT,MAAMkE,EAAM,SAAS,OAAOlE,EAAG,aAAaqD,CAAI,CAAC,EAAG,EAAE,EACtD,GAAI,CAAC,SAASa,CAAG,EAAG,OACpB,MAAMC,EAAYP,EAAW1B,CAAI,EAC3BkC,EAAUD,EAAYA,EAAUpB,CAAE,EAAI,CAAA,EAC5CgB,EAAUG,EAAKhC,EAAMkC,CAAO,CAC9B,CAEA,UAAWlC,KAAQ2B,EAEjB,SAAS,iBAAiB3B,EAAOa,GAAOiB,EAAe9B,EAAMa,CAAE,CAAC,EAElE,SAAS,iBAAiB,QAAUA,GAAOiB,EAAe,QAASjB,CAAE,EAAG,EAAI,EAC5E,SAAS,iBAAiB,OAASA,GAAOiB,EAAe,OAAQjB,CAAE,EAAG,EAAI,CAC5E,CC3GA,SAASsB,GAA4E,CACnF,MAAO,CACL,KAAM,OAAO,SAAS,IAAI,EAC1B,KAAM,OAAO,SAAS,QAAQ,EAC9B,MAAO,OAAO,SAAS,MAAM,EAC7B,KAAM,OAAO,SAAS,IAAI,CAAA,CAE9B,CAGA,SAASC,GAAoB,CAC3B,MAAMtE,EAAK,SAAS,eAAe,uBAAuB,EAC1D,GAAI,CAACA,EAAI,MAAO,GAChB,GAAI,CACF,MAAMmD,EAAO,KAAK,MAAMnD,EAAG,aAAe,IAAI,EAC9C,OAAO,OAAOmD,EAAK,QAAU,EAAE,CACjC,MAAQ,CACN,MAAO,EACT,CACF,CAEA,SAASoB,GAAc,CAErBrB,EAAA,EAGA,MAAMhC,EAASoD,EAAA,EACfR,EAAsB,CAACI,EAAKhC,EAAMkC,IAAY,CAC5CnC,EAAK,CAAE,EAAG,QAAS,OAAAf,EAAQ,IAAAgD,EAAK,KAAAhC,EAAM,EAAGkC,EAAS,CACpD,CAAC,EAID,OAAO,iBAAiB,WAAY,IAAM,CACxCnC,EAAK,CACH,EAAG,WACH,OAAAf,EACA,KAAM,WACN,EAAGmD,EAAA,CAAa,CACjB,CACH,CAAC,EAED,OAAO,iBAAiB,aAAetB,GAAwB,CAC7Dd,EAAK,CACH,EAAG,WACH,OAAAf,EACA,KAAM,aACN,EAAG,CACD,IAAKmD,EAAA,EACL,OAAQ,OAAOtB,EAAG,QAAU,EAAE,EAC9B,OAAQ,OAAOA,EAAG,QAAU,EAAE,EAC9B,KAAM,OAAO,SAAS,IAAI,CAAA,CAC5B,CACD,CACH,CAAC,EAED,SAAS,iBAAiB,mBAAoB,IAAM,CAClDd,EAAK,CACH,EAAG,WACH,OAAAf,EACA,KAAM,aACN,EAAG,CAAE,MAAO,OAAO,SAAS,iBAAmB,EAAE,CAAA,CAAE,CACpD,CACH,CAAC,EAED,OAAO,iBAAiB,QAAS,IAAM,CACrCe,EAAK,CACH,EAAG,WACH,OAAAf,EACA,KAAM,QACN,EAAG,CAAE,QAAS,EAAA,CAAK,CACpB,CACH,CAAC,EAED,OAAO,iBAAiB,OAAQ,IAAM,CACpCe,EAAK,CACH,EAAG,WACH,OAAAf,EACA,KAAM,QACN,EAAG,CAAE,QAAS,EAAA,CAAM,CACrB,CACH,CAAC,EAED,OAAO,iBAAiB,SAAU,IAAM,CACtCe,EAAK,CACH,EAAG,WACH,OAAAf,EACA,KAAM,SACN,EAAG,CAAE,OAAQ,EAAA,CAAK,CACnB,CACH,CAAC,EAED,OAAO,iBAAiB,UAAW,IAAM,CACvCe,EAAK,CACH,EAAG,WACH,OAAAf,EACA,KAAM,SACN,EAAG,CAAE,OAAQ,EAAA,CAAM,CACpB,CACH,CAAC,CACH,CAEAqD,EAAA"}