name: Nightly (fuzz + perf)

on:
  schedule:
    - cron: "0 4 * * *"
  workflow_dispatch:

jobs:
  nightly:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust (stable + nightly)
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: nightly
          components: llvm-tools-preview
      - name: Rust cache
        uses: Swatinem/rust-cache@v2
      - name: Install cargo-bolero
        run: cargo install cargo-bolero --locked
      - name: Fuzz parser (long)
        run: cargo bolero test -p aivi-fuzz parser::parser --engine libfuzzer -- -max_total_time=300 -timeout=30 -rss_limit_mb=4096
      - name: Fuzz frontend (long)
        run: cargo bolero test -p aivi-fuzz frontend::frontend --engine libfuzzer -- -max_total_time=300 -timeout=30 -rss_limit_mb=4096
      - name: Fuzz runtime (long)
        run: cargo bolero test -p aivi-fuzz runtime::runtime --engine libfuzzer -- -max_total_time=300 -timeout=30 -rss_limit_mb=4096
      - name: Fuzz formatter (long)
        run: cargo bolero test -p aivi-fuzz formatter::formatter --engine libfuzzer -- -max_total_time=300 -timeout=30 -rss_limit_mb=4096
      - name: Fuzz LSP pipeline (long)
        run: cargo bolero test -p aivi-fuzz lsp_pipeline::lsp_pipeline --engine libfuzzer -- -max_total_time=300 -timeout=30 -rss_limit_mb=4096
      - name: Fuzz type inference (long)
        run: cargo bolero test -p aivi-fuzz type_inference::type_inference --engine libfuzzer -- -max_total_time=300 -timeout=30 -rss_limit_mb=4096
      - name: Fuzz native codegen (long)
        run: cargo bolero test -p aivi-fuzz native_codegen::native_codegen --engine libfuzzer -- -max_total_time=300 -timeout=30 -rss_limit_mb=4096
      - name: Perf check (tighter)
        run: cargo run -p aivi --bin perf -- check --baseline crates/aivi/perf/baseline.json --max-multiplier 1.25
      - name: Upload perf report
        run: cargo run -p aivi --bin perf -- run > perf_report.json
      - uses: actions/upload-artifact@v4
        with:
          name: perf_report
          path: perf_report.json

