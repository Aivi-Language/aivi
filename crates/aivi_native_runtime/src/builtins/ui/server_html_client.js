(function(){"use strict";const y=new Map;function f(t){const e=y.get(t);if(e&&e.isConnected)return e;const n=document.querySelector(`[data-aivi-node="${CSS.escape(t)}"]`);return n&&y.set(t,n),n}function N(t,e){const n=f(t);if(!n)return;const r=document.createElement("template");r.innerHTML=String(e||"");const o=r.content.firstElementChild;o&&(n.replaceWith(o),y.clear())}function A(t){if(!(!t||typeof t.op!="string"))switch(t.op){case"replace":N(String(t.id||""),t.html);break;case"setText":{const e=f(String(t.id||""));e&&(e.textContent=String(t.text||""));break}case"setAttr":{const e=f(String(t.id||""));e&&e.setAttribute(String(t.name||""),String(t.value||""));break}case"removeAttr":{const e=f(String(t.id||""));e&&e.removeAttribute(String(t.name||""));break}}}function R(t){let e;try{e=JSON.parse(t)}catch{return}if(Array.isArray(e))for(const n of e)A(n)}const d=new Map;function K(t,e,n,r,o){let i=d.get(t);if(!i){let a=function(){if(k=!1,!u.length)return;const w=u;u=[],r({t:"platform",viewId:o,kind:"intersection",p:{sid:t,entries:w}})};const l=new WeakMap,g=new Map;let u=[],k=!1;i={observer:new IntersectionObserver(w=>{for(const v of w){const I=l.get(v.target);typeof I=="number"&&u.push({tid:I,isIntersecting:!!v.isIntersecting,ratio:typeof v.intersectionRatio=="number"?v.intersectionRatio:0})}k||(k=!0,requestAnimationFrame(a))},{root:null,rootMargin:typeof e.rootMargin=="string"?e.rootMargin:"0px",threshold:Array.isArray(e.threshold)?e.threshold:[0]}),elementToTid:l,tidToNodeId:g},d.set(t,i)}for(const a of n){if(!a||typeof a.tid!="number"||typeof a.nodeId!="string")continue;i.tidToNodeId.set(a.tid,a.nodeId);const l=f(a.nodeId);l&&(i.elementToTid.set(l,a.tid),i.observer.observe(l))}}function C(t){const e=d.get(t);if(e){try{e.observer.disconnect()}catch{}d.delete(t)}}function E(t){return t&&typeof t=="object"&&"name"in t?String(t.name):"Error"}function M(t,e,n,r){const o=e.kind;if(o==="clipboard.readText"){if(!navigator.clipboard||!navigator.clipboard.readText){n({t:"effectResult",viewId:r,rid:t,kind:o,ok:!1,error:"Unavailable"});return}navigator.clipboard.readText().then(i=>{n({t:"effectResult",viewId:r,rid:t,kind:o,ok:!0,p:{text:i}})}).catch(i=>{n({t:"effectResult",viewId:r,rid:t,kind:o,ok:!1,error:E(i)})});return}if(o==="clipboard.writeText"){if(!navigator.clipboard||!navigator.clipboard.writeText){n({t:"effectResult",viewId:r,rid:t,kind:o,ok:!1,error:"Unavailable"});return}const i=e.text??"";navigator.clipboard.writeText(i).then(()=>{n({t:"effectResult",viewId:r,rid:t,kind:o,ok:!0,p:{}})}).catch(a=>{n({t:"effectResult",viewId:r,rid:t,kind:o,ok:!1,error:E(a)})})}}function O(){const t=document.getElementById("aivi-server-html-boot");if(!t)return null;try{return JSON.parse(t.textContent||"{}")}catch{return null}}function W(t){return typeof t!="string"||!t?null:t.startsWith("ws://")||t.startsWith("wss://")?t:t.startsWith("/")?(location.protocol==="https:"?"wss://":"ws://")+location.host+t:t}let p="",h=null,s=null,b=1e3;const q=3e4,m=[];function c(t){if(s&&s.readyState===WebSocket.OPEN)try{s.send(JSON.stringify(t))}catch{}else m.push(t)}function J(){for(;m.length>0;){const t=m.shift();c(t)}}function _(t){switch(t.t){case"patch":R(t.ops);break;case"error":console.warn("[aivi] server error:",t.code,t.detail);break;case"subscribeIntersect":K(t.sid,t.options,t.targets,c,p);break;case"unsubscribeIntersect":C(t.sid);break;case"effectReq":M(t.rid,t.op,c,p);break;default:console.warn("[aivi] unknown server msg type:",t.t)}}function L(){h&&(s=new WebSocket(h),s.addEventListener("open",()=>{b=1e3,c({t:"hello",viewId:p,url:String(location.href),online:!!navigator.onLine}),J()}),s.addEventListener("message",t=>{let e=null;try{e=JSON.parse(String(t.data))}catch{return}e&&_(e)}),s.addEventListener("close",()=>{s=null,D()}),s.addEventListener("error",()=>{}))}function D(){const t=b;b=Math.min(b*2,q),setTimeout(L,t)}function P(){const t=O();!t||!t.viewId||(p=String(t.viewId),h=W(t.wsUrl??t.wsPath??"/aivi/live"),h&&L())}function B(t,e){let n=t;for(;n&&n!==document.body&&n!==document;){if(n.getAttribute&&n.getAttribute(e))return n;n=n.parentNode}return null}function U(t){return{button:t.button|0,alt:!!t.altKey,ctrl:!!t.ctrlKey,shift:!!t.shiftKey,meta:!!t.metaKey}}function X(t){let e="";try{const n=t.target;n&&"value"in n&&(e=String(n.value))}catch{}return{value:e}}function x(t){return{key:String(t.key||""),code:String(t.code||""),alt:!!t.altKey,ctrl:!!t.ctrlKey,shift:!!t.shiftKey,meta:!!t.metaKey,repeat:!!t.repeat,isComposing:!!t.isComposing}}function S(t){return{pointerId:t.pointerId|0,pointerType:String(t.pointerType||""),button:t.button|0,buttons:t.buttons|0,clientX:+t.clientX||0,clientY:+t.clientY||0,alt:!!t.altKey,ctrl:!!t.ctrlKey,shift:!!t.shiftKey,meta:!!t.metaKey}}const Y={click:U,input:X,keydown:x,keyup:x,pointerdown:S,pointerup:S,pointermove:S},F=["click","input","keydown","keyup","pointerdown","pointerup","pointermove"];function H(t){function e(n,r){const o=`data-aivi-hid-${n}`;let i=r.target;i&&i.nodeType===3&&(i=i.parentNode);const a=B(i,o);if(!a)return;const l=parseInt(String(a.getAttribute(o)),10);if(!isFinite(l))return;const g=Y[n],u=g?g(r):{};t(l,n,u)}for(const n of F)document.addEventListener(n,r=>e(n,r));document.addEventListener("focus",n=>e("focus",n),!0),document.addEventListener("blur",n=>e("blur",n),!0)}function T(){return{href:String(location.href),path:String(location.pathname),query:String(location.search),hash:String(location.hash)}}function V(){const t=document.getElementById("aivi-server-html-boot");if(!t)return"";try{const e=JSON.parse(t.textContent||"{}");return String(e.viewId||"")}catch{return""}}function $(){P();const t=V();H((e,n,r)=>{c({t:"event",viewId:t,hid:e,kind:n,p:r})}),window.addEventListener("popstate",()=>{c({t:"platform",viewId:t,kind:"popstate",p:T()})}),window.addEventListener("hashchange",e=>{c({t:"platform",viewId:t,kind:"hashchange",p:{url:T(),oldURL:String(e.oldURL||""),newURL:String(e.newURL||""),hash:String(location.hash)}})}),document.addEventListener("visibilitychange",()=>{c({t:"platform",viewId:t,kind:"visibility",p:{state:String(document.visibilityState||"")}})}),window.addEventListener("focus",()=>{c({t:"platform",viewId:t,kind:"focus",p:{focused:!0}})}),window.addEventListener("blur",()=>{c({t:"platform",viewId:t,kind:"focus",p:{focused:!1}})}),window.addEventListener("online",()=>{c({t:"platform",viewId:t,kind:"online",p:{online:!0}})}),window.addEventListener("offline",()=>{c({t:"platform",viewId:t,kind:"online",p:{online:!1}})})}$()})();
//# sourceMappingURL=aivi-server-html-client.js.map
